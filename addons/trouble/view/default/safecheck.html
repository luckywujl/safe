{layout name="common/layout8" /}
<style data-render="style">
    .example {
        height: 100%;
        position: relative;
    }

    .example>span {
        position: absolute;
        right: 10px;
        top: 10px;
    }

    .fixed-table-container {
        border: none !important;
    }
    .widget-user .widget-user-image {
        top: 70px;
    }
    .widget-user-2 .widget-user-image>img {
        width: 30px !important;
        height: 30px !important;
    }

    .fc-event-main {
        cursor: pointer;
    }

    .attachment-block {
        border: none;
        padding: 5px;
        margin-bottom: 10px;
        background: #ffffff;
    }

    .breadcrumb {
        padding: 0px 0px;
        margin-bottom: 0px;
        list-style: none;
        background-color: transparent !important;
        border-radius: 3px;
        line-height: 40px;
    }

    .table-template {
        height: 770px;
    }

    .fixed-table-pagination {
        margin: 0px 15px;
    }

    .tab-badge>.badge {
        display: inline-block;
        min-width: 10px;
        padding: 2px 5px;
        font-size: 7px !important;
        font-weight: normal !important;
        color: #fff;
        line-height: 1;
        vertical-align: middle;
        white-space: nowrap;
        text-align: center;
        background-color: #777777;
        border-radius: 10px;
        position: absolute;
        top: 0px;
        right: -2px;
    }

    .description-header {
        font-size: 24px !important;
    }

	.panel-post {
		position: relative;
	}

	.btn-post {
		position: absolute;
		right: 0;
		bottom: 10px;
	}

	.img-border {
		border-radius: 3px;
		box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.05);
	}
</style>

<div class="container mt-20">
	<div class="col-md-9">
		<div class="panel panel-default panel-user">
			<div class="panel-body">
				<form id="edit-form" class="form-horizontal" role="form" data-toggle="validator" method="POST"
					action="{:addon_url('trouble/Index/safecheck')}">
		
					<div class="page-header panel-post">

						<div class="form-group">
							<label class="control-label col-xs-8 col-sm-2">安全检查</label>
							<button type="submit" class="btn btn-success btn-embossed">{:__('提交隐患')}</button>
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Point_id')}:</label>
						<div class="col-xs-12 col-sm-7">
							<!-- <input id="c-point_id" data-source="{:addon_url('trouble/index/selectpoint')}"
								data-field="point_name" data-primary-key='id' class="form-control selectpage"
								name="row[point_id]" type="text" value=""> -->
							<input id="c-point_id" class="form-control" name="row[point_id]" type="text" value="">
						</div>
						<div class="col-xs-12 col-sm-7" hidden="hidden">

							<input id="c-source_type" readonly="readonly" class="form-control" name="row[source_type]"
								type="text" value="2">
						</div>

					</div>
					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Point_address')}:</label>
						<div class="col-xs-12 col-sm-7">
							<input id="c-point_address" readonly="readonly" class="form-control" type="text" value="">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Kind')}:</label>
						<div data-toggle="cxselect" data-selects="kind,type,expression">
							<div class="col-xs-12 col-sm-2">
								<select class="kind form-control" name="row[kind]" data-rule="required"
									data-url="{:addon_url('trouble/Index/expression')}">
								</select>
							</div>
							<label class="control-label col-xs-12 col-sm-1">{:__('Type')}:</label>
							<div class="col-xs-12 col-sm-2">
								<select class="type form-control" name="row[type]" data-rule="required"
									data-url="{:addon_url('trouble/Index/expression')}">
								</select>
							</div>
							<label class="control-label col-xs-12 col-sm-1">{:__('Expression')}:</label>
							<div class="col-xs-12 col-sm-2">
								<select class="expression form-control" name="row[expression]" data-rule="required"
									data-url="{:addon_url('trouble/Index/expression')}">
								</select>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Level')}:</label>
						<div data-toggle="cxselect" data-selects="level">
							<div class="col-xs-12 col-sm-8">
								<select class="level form-control" name="row[level]" data-rule="required"
									data-url="{:addon_url('trouble/Index/level')}">
								</select>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Violations')}:</label>
						<div class="col-xs-12 col-sm-8">
							<select id="c-violations" class="province form-control" name="row[violations]">
								<option value=" " selected>请选择</option>
								<option value="违章指挥">违章指挥</option>
								<option value="违规作业">违规作业</option>
								<option value="违反劳动纪律">违反劳动纪律</option>
							</select>
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Description')}:</label>
						<div class="col-xs-12 col-sm-8">
							<textarea id="c-description" class="form-control " rows="3" name="row[description]"
								cols="50"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Trouble_pic')}:</label>
						<div class="col-xs-12 col-sm-8">
							<div class="input-group">
								<input id="c-trouble_pic" class="form-control" data-rule="required"
									name="row[trouble_pic]" type="text" readonly="readonly" placeholder="暂无照片">
								<div class="input-group-addon no-border no-padding">
									<span><button type="button" id="faupload-process_pic"
											class="btn btn-danger faupload" data-input-id="c-trouble_pic"
											data-mimetype="image/gif,image/jpeg,image/png,image/jpg,image/bmp"
											data-multiple="true" data-preview-id="p-trouble_pic"><i
												class="fa fa-upload"></i> {:__('Upload')}</button></span>
									<span><button type="button" id="facamera-process_pic"
											class="btn btn-primary faupload" data-input-id="c-trouble_pic"
											data-mimetype="image/*" data-multiple="true"><i class="fa fa-camera"></i>
											{:__('photo')}</button></span>
								</div>
								<span class="msg-box n-right" for="c-trouble_pic"></span>
							</div>
							<ul class="row list-inline faupload-preview" id="p-trouble_pic" data-template="customtpl">
							</ul>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Remark')}:</label>
						<div class="col-xs-12 col-sm-8">

							<textarea id="c-remark" class="form-control " rows="5" name="row[remark]"
								cols="50"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-xs-12 col-sm-2">{:__('Limittime')}:</label>
						<div class="col-xs-12 col-sm-8">
							<input id="c-limittime" class="form-control datetimepicker" data-rule="required;"
								data-date-format="YYYY-MM-DD HH:mm:ss" data-use-current="true" name="row[limittime]"
								type="text" value="{:date('Y-m-d H:i:s',strtotime(" +3 day"))}">
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<script type="text/html" id="customtpl">

<li class="col-xs-3">
    <a  data-url="<%=url%>" target="_blank" class="thumbnail"><img src="<%=fullurl%>" class="img-responsive"></a><a href="javascript:;" class="btn btn-danger btn-xs btn-trash"><i class="fa fa-trash"></i></a>
</li>
</script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
<script data-render="script">
	require.callback = function () {
		define('training/index', ['jquery', 'bootstrap', 'frontend', 'backend', 'table', 'fullcalendar-lang', 'fullcalendar', 'moment', 'moment/locale/zh-cn', 'panelslider', 'form', 'layer', 'template', 'selectpage'], function ($, undefined, Frontend, Backend, Table, CalendarLocale, Calendar, Moment, undefined, panelslider, Form, Layer, Template) {

			var Controller = {
				safecheck: function () {
					$("#c-point_id").selectPage({           //设置材料编号（即水表型号）的下拉列表框
						showField: 'point_name',
						keyField: 'id',
						data: "{:addon_url('trouble/index/selectpoint')}",
						pageSize: 10,
						eAjaxSuccess: function (data) {
							data.list = typeof data.rows !== 'undefined' ? data.rows : (typeof data.list !== 'undefined' ? data.list : []);
							data.totalRow = typeof data.total !== 'undefined' ? data.total : (typeof data.totalRow !== 'undefined' ? data.totalRow : data.list.length);
							return data;
						},
						eSelect: function (data) {
							console.info(data);
							Fast.api.ajax({
								url: "{:addon_url('trouble/index/getpoint')}",
								data: { id: data.id } //再将收到的create_code用POST方式发给主表控制器的total
							},
								function (data, ret) { //success 用于接收主表控制器发过来的数据
									$("#c-point_address").val(data.point_address);
									//console.info(data);
									return false;
								}, function (data) {
									//失败的回调   
									return false;
								}
							)
						},
					});
					Controller.api.bindEvent();
				},
				api: {
					bindEvent() {
						Form.api.bindevent($("form[role=form]"), function (data, ret) {
							alert(ret.msg);		
							 $.ajax({
								url: "{:addon_url('trouble/index/send_d')}",
								type: 'post',
								dataType: 'json',
							    data: ret.data,
								success: function (ret) {
									alert(ret.msg);
								}, error: function (e) {
									
								}
							});	
							location.reload();//刷新页面

							// setTimeout(function () {
							// 	// 安卓关闭当前窗口
							// 	document.addEventListener('WeixinJSBridgeReady', function () {
							// 		WeixinJSBridge.call('closeWindow')
							// 	}, false)
							// 	// IOS关闭当前窗口
							// 	WeixinJSBridge.call('closeWindow')
							// }, 10)
						});
					}
				}
			};
			return Controller;
		});
	}
</script>